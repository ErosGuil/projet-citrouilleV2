<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPECIMEN 001 - PROJET CITROUILLE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a0a00 0%, #0a0a0a 100%);
            color: #0f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ff6600;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 102, 0, 0.5);
            width: 100%;
            max-width: 800px;
        }
        
        .header h1 {
            color: #ff6600;
            font-size: 36px;
            text-shadow: 0 0 20px #ff6600;
            margin-bottom: 15px;
            letter-spacing: 3px;
        }
        
        .classified {
            color: #f00;
            font-size: 12px;
            letter-spacing: 5px;
            margin-bottom: 10px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        
        .description {
            color: #0f0;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 15px;
        }
        
        .main-container {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #0f0;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            width: 100%;
            max-width: 800px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: rgba(255, 102, 0, 0.2);
            border: 2px solid #ff6600;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-label {
            color: #0f0;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #ff6600;
            font-size: 24px;
            font-weight: bold;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #detectVideo {
            width: 100%;
            border: 3px solid #0f0;
            border-radius: 10px;
            background: #000;
            display: none;
        }
        
        #detectCanvas {
            width: 100%;
            border: 3px solid #0f0;
            border-radius: 10px;
            background: #000;
        }
        
        #scanOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .scan-line {
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #0f0, transparent);
            position: absolute;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .target-reticle {
            width: 200px;
            height: 200px;
            border: 3px solid #ff6600;
            border-radius: 50%;
            position: relative;
            opacity: 0.7;
        }
        
        .target-reticle::before,
        .target-reticle::after {
            content: '';
            position: absolute;
            background: #ff6600;
        }
        
        .target-reticle::before {
            width: 100%;
            height: 3px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        
        .target-reticle::after {
            width: 3px;
            height: 100%;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        
        .message {
            text-align: center;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
            min-height: 60px;
        }
        
        .info-box {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #0f0;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .info-box h3 {
            color: #ff6600;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-box ul {
            color: #0f0;
            font-size: 14px;
            line-height: 1.8;
            list-style: none;
            padding-left: 0;
        }
        
        .info-box li::before {
            content: "‚ñ∏ ";
            color: #ff6600;
            font-weight: bold;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #ff6600;
            color: #000;
            border: none;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            margin-top: 15px;
        }
        
        button:hover {
            background: #ff8800;
            box-shadow: 0 0 20px rgba(255, 102, 0, 0.8);
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .detection-log {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #0f0;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .detection-log h4 {
            color: #0f0;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .log-entry {
            color: #ffaa00;
            font-size: 12px;
            font-family: monospace;
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #ff6600;
            padding-left: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6600, #ffaa00);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 14px;
        }
        
        .success {
            background: rgba(0, 255, 0, 0.2);
            border-color: #0f0;
            color: #0f0;
        }
        
        .warning {
            background: rgba(255, 170, 0, 0.2);
            border-color: #ffaa00;
            color: #ffaa00;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            border-color: #f00;
            color: #f00;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="classified">‚ö†Ô∏è CONFIDENTIEL - NIVEAU 5 ‚ö†Ô∏è</div>
        <h1>SPECIMEN 001</h1>
        <div style="color: #ff6600; font-size: 18px; margin: 10px 0;">PROJET CITROUILLE</div>
        <div class="description">
            <p>Mission d'identification de sp√©cimen prioritaire.</p>
            <p>Protocole de scan activ√©. Localisation requise.</p>
            <p style="color: #f00; margin-top: 10px;">‚ö†Ô∏è CLASSIFICATION : TOP SECRET</p>
        </div>
    </div>
    
    <div class="main-container">
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">Confiance</div>
                <div class="stat-value" id="confidence">0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Temps</div>
                <div class="stat-value" id="timer">60s</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Statut</div>
                <div class="stat-value" id="status" style="font-size: 16px;">ATTENTE</div>
            </div>
        </div>
        
        <div class="info-box">
            <h3>üìã PROTOCOLE DE SCAN</h3>
            <ul>
                <li>Localiser le SPECIMEN 001 dans votre environnement</li>
                <li>Cadrer le sp√©cimen dans la zone de scan</li>
                <li>Maintenir la cible pendant 3 secondes minimum</li>
                <li>Validation automatique √† 80% de confiance</li>
            </ul>
        </div>
        
        <div class="video-container">
            <video id="detectVideo" autoplay playsinline></video>
            <canvas id="detectCanvas"></canvas>
            <div id="scanOverlay">
                <div class="scan-line"></div>
                <div class="target-reticle"></div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%;">0%</div>
        </div>
        
        <div id="message" class="message">
            üéØ Cliquez sur "ACTIVER LE SCAN" pour commencer la mission
        </div>
        
        <div class="detection-log">
            <h4>üì° JOURNAL DE D√âTECTION</h4>
            <div id="logEntries">
                <div class="log-entry">SYST√àME: En attente d'activation...</div>
            </div>
        </div>
        
        <button onclick="startScan()" id="scanBtn">üì° ACTIVER LE SCAN</button>
        <button onclick="window.close()" style="background: #666; margin-top: 10px;">üö™ QUITTER</button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <script>
        let scanActive = false;
        let model = null;
        let video = null;
        let canvas = null;
        let ctx = null;
        let stream = null;
        let animationFrame = null;
        let detectionTimer = null;
        let timeLeft = 60;
        let currentConfidence = 0;
        let holdTimer = 0;
        let lastDetectionTime = 0;
        
        // Crit√®res de validation
        const TARGET_OBJECT = 'car'; // L'objet √† d√©tecter
        const REQUIRED_HOLD_TIME = 3; // Secondes
        const MIN_CONFIDENCE = 0.80; // 80% de confiance
        
        async function startScan() {
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ INITIALISATION...';
            
            addLog('SYST√àME: Initialisation du scan en cours...');
            updateMessage('üîÑ Chargement du syst√®me de d√©tection...', 'warning');
            
            try {
                // Initialiser la vid√©o
                video = document.getElementById('detectVideo');
                canvas = document.getElementById('detectCanvas');
                ctx = canvas.getContext('2d');
                
                addLog('SYST√àME: Activation de la cam√©ra...');
                
                // Demander l'acc√®s √† la cam√©ra
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                await new Promise(resolve => {
                    video.onloadedmetadata = resolve;
                });
                
                // Ajuster la taille du canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                addLog('SYST√àME: Cam√©ra activ√©e avec succ√®s');
                updateMessage('üß† Chargement du mod√®le de d√©tection IA...', 'warning');
                
                // Charger le mod√®le
                addLog('SYST√àME: Chargement du mod√®le TensorFlow...');
                model = await cocoSsd.load();
                addLog('SYST√àME: Mod√®le charg√© - Pr√™t √† scanner');
                
                // D√©marrer le scan
                scanActive = true;
                timeLeft = 60;
                holdTimer = 0;
                
                document.getElementById('status').textContent = 'ACTIF';
                updateMessage('üéØ RECHERCHE DU SPECIMEN 001 EN COURS...', 'warning');
                
                btn.textContent = 'üõë ARR√äTER LE SCAN';
                btn.onclick = stopScan;
                btn.disabled = false;
                
                // Lancer la boucle de d√©tection
                detectLoop();
                
                // Timer
                detectionTimer = setInterval(() => {
                    if (scanActive) {
                        timeLeft--;
                        document.getElementById('timer').textContent = timeLeft + 's';
                        
                        if (timeLeft <= 0) {
                            failMission();
                        } else if (timeLeft <= 15) {
                            document.getElementById('timer').style.color = '#f00';
                        }
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Erreur:', error);
                addLog('ERREUR: ' + error.message);
                updateMessage('‚ùå ERREUR: Impossible d\'acc√©der √† la cam√©ra', 'error');
                btn.disabled = false;
                btn.textContent = 'üîÑ R√âESSAYER';
                btn.onclick = startScan;
            }
        }
        
        async function detectLoop() {
            if (!scanActive) return;
            
            // Dessiner la vid√©o sur le canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // D√©tecter les objets
            const predictions = await model.detect(canvas);
            
            // Chercher une voiture
            let carFound = false;
            let maxCarConfidence = 0;
            let carPrediction = null;
            
            predictions.forEach(prediction => {
                // Dessiner les bo√Ætes de d√©tection
                const [x, y, width, height] = prediction.bbox;
                
                // V√©rifier si c'est une voiture
                if (prediction.class === TARGET_OBJECT && prediction.score > maxCarConfidence) {
                    maxCarConfidence = prediction.score;
                    carPrediction = prediction;
                    carFound = true;
                }
                
                // Dessiner la bo√Æte
                const isCar = prediction.class === TARGET_OBJECT;
                ctx.strokeStyle = isCar ? '#0f0' : '#ff6600';
                ctx.lineWidth = isCar ? 4 : 2;
                ctx.strokeRect(x, y, width, height);
                
                // Label
                ctx.fillStyle = ctx.strokeStyle;
                ctx.font = '16px Arial';
                const label = `${prediction.class} ${Math.floor(prediction.score * 100)}%`;
                ctx.fillText(label, x, y > 20 ? y - 5 : y + height + 20);
            });
            
            // Analyser la couleur si une voiture est trouv√©e
            if (carFound && carPrediction) {
                const [x, y, width, height] = carPrediction.bbox;
                const imageData = ctx.getImageData(x, y, width, height);
                const isOrange = analyzeColor(imageData);
                
                if (isOrange) {
                    // Voiture orange trouv√©e !
                    const confidence = Math.floor(maxCarConfidence * 100);
                    currentConfidence = confidence;
                    document.getElementById('confidence').textContent = confidence + '%';
                    
                    // Mettre √† jour la barre de progression
                    const holdProgress = Math.min((holdTimer / REQUIRED_HOLD_TIME) * 100, 100);
                    document.getElementById('progressBar').style.width = holdProgress + '%';
                    document.getElementById('progressBar').textContent = Math.floor(holdProgress) + '%';
                    
                    // Incr√©menter le timer de maintien
                    const now = Date.now();
                    if (now - lastDetectionTime > 100) {
                        holdTimer += 0.1;
                        lastDetectionTime = now;
                    }
                    
                    // Dessiner un cadre sp√©cial autour de la cible
                    ctx.strokeStyle = '#0f0';
                    ctx.lineWidth = 6;
                    ctx.strokeRect(x - 5, y - 5, width + 10, height + 10);
                    
                    if (confidence >= MIN_CONFIDENCE * 100) {
                        if (holdTimer >= REQUIRED_HOLD_TIME) {
                            // SUCC√àS !
                            successMission(confidence);
                            return;
                        } else {
                            const remainingTime = (REQUIRED_HOLD_TIME - holdTimer).toFixed(1);
                            updateMessage(`üéØ SPECIMEN 001 VERROUILL√â ! Maintenir ${remainingTime}s...`, 'success');
                            
                            if (holdTimer > 1 && Math.floor(holdTimer) !== Math.floor(holdTimer - 0.1)) {
                                addLog(`SCAN: Verrouillage en cours... ${Math.ceil(remainingTime)}s restantes`);
                            }
                        }
                    } else {
                        updateMessage(`‚ö†Ô∏è SPECIMEN d√©tect√© mais confiance insuffisante (${confidence}% < ${MIN_CONFIDENCE * 100}%)`, 'warning');
                        holdTimer = Math.max(0, holdTimer - 0.2);
                    }
                } else {
                    // Voiture mais pas orange
                    updateMessage('üöó V√©hicule d√©tect√© mais couleur incorrecte. Continuez la recherche...', 'warning');
                    holdTimer = Math.max(0, holdTimer - 0.1);
                }
            } else {
                // Pas de voiture d√©tect√©e
                holdTimer = Math.max(0, holdTimer - 0.1);
                if (predictions.length === 0) {
                    updateMessage('üîç Balayage de la zone... Aucun sp√©cimen d√©tect√©', 'warning');
                } else {
                    updateMessage('üîç Objets d√©tect√©s mais aucun sp√©cimen correspondant', 'warning');
                }
            }
            
            // Mettre √† jour la barre de progression
            const holdProgress = Math.min((holdTimer / REQUIRED_HOLD_TIME) * 100, 100);
            document.getElementById('progressBar').style.width = holdProgress + '%';
            document.getElementById('progressBar').textContent = Math.floor(holdProgress) + '%';
            
            animationFrame = requestAnimationFrame(detectLoop);
        }
        
        function analyzeColor(imageData) {
            // Analyser les pixels pour d√©tecter du orange
            const data = imageData.data;
            let orangePixels = 0;
            let totalPixels = data.length / 4;
            
            // Sous-√©chantillonner pour les performances
            const step = 4;
            
            for (let i = 0; i < data.length; i += 4 * step) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // D√©tection du orange (teinte entre rouge et jaune)
                // Orange typique: R > 200, G entre 100-180, B < 100
                if (r > 180 && g > 80 && g < 200 && b < 120) {
                    // V√©rifier que c'est bien orange et pas rouge/jaune
                    if (r > g && g > b * 1.5) {
                        orangePixels++;
                    }
                }
            }
            
            const orangePercentage = (orangePixels / (totalPixels / step)) * 100;
            
            // Au moins 15% de pixels orange
            return orangePercentage > 15;
        }
        
        function successMission(confidence) {
            scanActive = false;
            clearInterval(detectionTimer);
            cancelAnimationFrame(animationFrame);
            
            addLog(`‚úÖ SUCC√àS: SPECIMEN 001 identifi√© avec ${confidence}% de confiance`);
            addLog(`SYST√àME: Coordonn√©es GPS enregistr√©es`);
            addLog(`SYST√àME: Donn√©es transmises au QG`);
            
            document.getElementById('status').textContent = 'R√âUSSI';
            document.getElementById('status').style.color = '#0f0';
            
            updateMessage(`
                üéâ MISSION ACCOMPLIE !<br>
                <span style="font-size: 14px;">
                    SPECIMEN 001 localis√© et identifi√©<br>
                    Confiance: ${confidence}%<br>
                    Temps: ${60 - timeLeft}s<br>
                    <br>
                    üì° Rapport transmis au Projet Citrouille
                </span>
            `, 'success');
            
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressBar').textContent = 'VALID√â ‚úì';
            
            const btn = document.getElementById('scanBtn');
            btn.textContent = '‚úÖ MISSION TERMIN√âE';
            btn.onclick = null;
            btn.disabled = true;
            
            // Effet de victoire
            canvas.style.borderColor = '#0f0';
            document.querySelector('.main-container').style.borderColor = '#0f0';
        }
        
        function failMission() {
            scanActive = false;
            clearInterval(detectionTimer);
            cancelAnimationFrame(animationFrame);
            
            addLog('‚ùå √âCHEC: Temps √©coul√© - Mission non accomplie');
            addLog('SYST√àME: Retour au QG requis');
            
            document.getElementById('status').textContent = '√âCHOU√â';
            document.getElementById('status').style.color = '#f00';
            
            updateMessage(`
                ‚è∞ TEMPS √âCOUL√â !<br>
                <span style="font-size: 14px;">
                    Le SPECIMEN 001 n'a pas pu √™tre localis√©<br>
                    Mission √† recommencer
                </span>
            `, 'error');
            
            const btn = document.getElementById('scanBtn');
            btn.textContent = 'üîÑ NOUVELLE TENTATIVE';
            btn.onclick = () => {
                location.reload();
            };
            btn.disabled = false;
            
            canvas.style.borderColor = '#f00';
        }
        
        function stopScan() {
            scanActive = false;
            clearInterval(detectionTimer);
            cancelAnimationFrame(animationFrame);
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            addLog('SYST√àME: Scan arr√™t√© par l\'utilisateur');
            updateMessage('‚èπÔ∏è Scan interrompu', 'warning');
            
            document.getElementById('status').textContent = 'ARR√äT√â';
            
            const btn = document.getElementById('scanBtn');
            btn.textContent = 'üì° REPRENDRE LE SCAN';
            btn.onclick = startScan;
        }
        
        function updateMessage(text, type = '') {
            const msg = document.getElementById('message');
            msg.innerHTML = text;
            msg.className = 'message ' + type;
        }
        
        function addLog(text) {
            const logEntries = document.getElementById('logEntries');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${text}`;
            logEntries.appendChild(entry);
            logEntries.scrollTop = logEntries.scrollHeight;
        }
    </script>
</body>
</html>